<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">

    <head lang="en" th:replace="base/header :: head">
        <title>Hanger</title>
    </head>

    <body>
        <th:block th:include="base/header :: navbar"></th:block>
        <div class="container-fluid main-content">
            <div class="tab-content">
                <table>
                    <tr>
                        <th>
                            <h3 class="page-title">Workbench</h3>
                        </th>
                        <th class="btn-action">
                            <a th:href="@{'/query/list/'}" 
                               title="Stored queries">
                                <span 
                                    class="glyphicon glyphicon-bookmark"></span>
                            </a>
                        </th>
                    </tr>            
                </table>

                <div class="form-horizontal">
                    <div th:if="${ errorMessage != null }" class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <div class="alert alert-danger" role="alert">
                                    <span th:text="${errorMessage}"></span>
                                </div>  
                            </div>
                        </div>
                    </div>
                    <div th:if="${ successMessage != null }" class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <div class="alert alert-info" role="alert">
                                    <span th:text="${successMessage}"></span>
                                </div>  
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label>Connection</label>
                                <select 
                                    id="connection" 
                                    class="selectpicker form-control" 
                                    data-live-search="true" 
                                    required="true" 
                                    placeholder="Connection">
                                    <option th:each="connection : ${connections}" 
                                            th:value="${connection.id}" 
                                            th:text="${connection.name}"
                                            th:selected="${connectionQueryStore != null ? connection == connectionQueryStore.connection : 0}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group col-div-jstree">
                                <input type="text"
                                       id="jstree-search"
                                       class="form-control form-control-search" 
                                       maxlength="50" 
                                       placeholder="Search: "/>

                                <div class="div-jstree">
                                    <div id="jstree"></div>
                                </div>                                
                            </div>
                        </div>
                        <div class="col-sm-9 col-div-query">
                            <div class="form-group">
                                <textarea 
                                    class="form-control" 
                                    id="query" 
                                    required="true" 
                                    rows="10" 
                                    minlength="1" 
                                    maxlength="5000"
                                    th:text="${connectionQueryStore != null ? connectionQueryStore.query : ''}"></textarea>
                            </div>
                        </div>
                    </div>                    

                    <div class="row">
                        <button 
                            id="store-query-button" 
                            class="btn btn-generic pull-right btn-space" 
                            type="button">

                            <span class="glyphicon glyphicon-floppy-disk" 
                                  aria-hidden="true"></span> Store
                        </button>

                        <div th:if="${#authorization.expression('hasRole(''HERO'')')}">
                            <button 
                                id="export-query-button" 
                                class="btn btn-generic pull-right btn-space" 
                                type="button">

                                <span class="glyphicon glyphicon-download-alt" 
                                      aria-hidden="true"></span> Export
                            </button>
                        </div>

                        <button 
                            id="query-button" 
                            class="btn btn-generic pull-right btn-space" 
                            type="button">

                            <span class="glyphicon glyphicon-search" 
                                  aria-hidden="true"></span> Query
                        </button>

                        <button 
                            id="wait" 
                            type="button"
                            class="btn btn-default btn-sm pull-left" 
                            style="display:none;">

                            <img th:src="@{'/images/ajax-loader.gif'}"></img>
                        </button>
                    </div>

                    <!--Fragment--> 
                    <div id="fragmentQueryResultSetHolder" class="space-top"/>
                </div>
            </div>

            <!--AJAX Parent modal --> 
            <div id="modalHolder"/>
        </div>

        <script th:inline="javascript">
            $(document).ready(function () {
                toastr.options = {
                    "closeButton": true,
                    "progressBar": true,
                    "positionClass": "toast-top-right",
                    "timeOut": "3500",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                }

                // Connection ID.
                var connection = $("#connection").val();

                // Tree initial construction.
                createJSTree(connection);

                /**
                 * Change connection event.
                 */
                $("#connection").change(function () {
                    connection = $(this).val();
                    createJSTree(connection);
                });

                window.editor = CodeMirror.fromTextArea(document.getElementById('query'), {
                    mode: 'text/x-sql',
                    indentWithTabs: true,
                    smartIndent: true,
                    lineNumbers: true,
                    matchBrackets: true,
                    autofocus: true,
                    extraKeys: {"Ctrl-Enter": function () {
                            $("#fragmentQueryResultSetHolder").show();
                            query();
                        }}
                });

                /**
                 * Set header CSRF Token.
                 * @returns {undefined}
                 */
                $.ajaxSetup({
                    headers: {'X-CSRF-Token': $('#_csrf').attr('content')}
                });

                /**
                 * Define ajax start behavior. 
                 * @returns {undefined}
                 */
                $(document).ajaxStart(function () {
                    $("#wait").css("display", "block");
                    $("#query").prop("disabled", true);
                    $("#query-button").prop("disabled", true);
                    $("#export-query-button").prop("disabled", true);
                });

                /**
                 * Define ajax complete behavior. 
                 * @returns {undefined}
                 */
                $(document).ajaxComplete(function () {
                    $("#wait").css("display", "none");
                    $("#query").prop("disabled", false);
                    $("#query-button").prop("disabled", false);
                    $("#export-query-button").prop("disabled", false);
                });

                /**
                 * Trigger job details search on search button click. 
                 */
                $("#query-button").click(function () {
                    $("#fragmentQueryResultSetHolder").show();
                    query();
                });

                /**
                 * Trigger job details search on history click.
                 * @returns {undefined}
                 */
                $("[id^=query_]").click(function () {
                    $("#fragmentQueryResultSetHolder").show();
                    query();
                });

                /**
                 * Opens modal to store a query.
                 */
                $("#store-query-button").click(function () {
                    queryStoreModal();
                });

                /**
                 * Jstree Search
                 * @returns {undefined}
                 */
                var timeOut = false;
                $('#jstree-search').keyup(function () {
                    if (timeOut) {
                        clearTimeout(timeOut);
                    }
                    timeOut = setTimeout(function () {
                        var v = $('#jstree-search').val();
                        $('#jstree').jstree(true).search(v);
                    }, 250);
                });

                /**
                 * 
                 */

                $('#jstree').on('dblclick', '.jstree-anchor', function (e) {
                    var instance = $.jstree.reference(this);
                    var node = instance.get_node(this);
                    var query = window.editor;
                    var select = "";

                    if (node.parent !== "#") {
                        select = "SELECT * FROM " + node.parent + "." + node.text + " LIMIT 10;";
                        query.setValue(select);
                        query.focus();
                    }
                });

                /**
                 * Opens modal to export a query.
                 */
                $("#export-query-button").click(function () {
                    $("#fragmentQueryResultSetHolder").hide();
                    queryExport();
                });

                /**
                 * Search for job that match the search input value. 
                 * @returns {undefined}
                 */
                function query() {
                    var connection = $('#connection').val();
                    var url = /*[[@{/workbench/query/}]]*/ "/workbench/query/";
                    var query = window.editor.getSelection();

                    if (query === "") {
                        query = window.editor.getValue();
                    }

                    if (query !== "") {
                        $.ajax({
                            type: "POST",
                            url: url + connection,
                            data: query,
                            contentType: "text/html",
                            timeout: 1000000,
                            success: function (result) {
                                $("#fragmentQueryResultSetHolder").html(result);
                                $('.table').DataTable(
                                        {
                                            "paging": false,
                                            "info": false,
                                            "searching": true,
                                            "retrieve": true,
                                            "order": [],
                                            "columnDefs": [{
                                                    "targets": 'no-sort',
                                                    "orderable": false
                                                }
                                            ]
                                        });
                            },
                            error: function (e) {
                                alert("Fail loading query resultset: "
                                        + e.statusText);
                            }
                        });
                    }
                }

                /**
                 * Construct jsTree
                 * @param connection
                 */
                function createJSTree(connection) {
                    // Clear jsTree.
                    $('#jstree').jstree("destroy").empty();

                    var url = /*[[@{/workbench/}]]*/ "/workbench/";

                    $('#jstree').jstree({
                        'core': {
                            'data': {
                                "url": url + "tree/" + connection,
                                "dataType": "json",
                                "data": function (node) {
                                    payload = {"catalog": "", "schema": ""};

                                    if (node.a_attr) {
                                        payload = {"catalog": node.a_attr.catalog, "schema": node.a_attr.schema};
                                    }

                                    return payload;
                                }
                            }
                        },
                        "plugins": ["sort", "wholerow", "contextmenu", "search"],
                        "search": {
                            "show_only_matches": true
                        },
                        'contextmenu': {
                            'items': customMenu
                        }
                    });
                }

                /**
                 * Refresh connection cache.
                 */
                function refreshCache() {
                    var url = /*[[@{/connection/evict/}]]*/ "/connection/evict/";

                    $.ajax({
                        type: "GET",
                        url: url + connection,
                        contentType: "text/html",
                        timeout: 1000000,
                        success: function () {
                            createJSTree(connection);

                        },
                        error: function (e) {
                            alert("Fail refreshing connection cache: " + e.statusText);
                        }
                    });
                }

                /**
                 * Right click menu on table list.
                 * 
                 * @param {type} node current element.
                 * @returns {workbenchL#2.customMenu.items}
                 */
                function customMenu(node) {
                    {
                        var items = {
                            'refresh': {
                                'label': 'Refresh',
                                'icon': 'glyphicon glyphicon-refresh',
                                'title': 'Refresh connection. (Shortcut F1)',
                                'shortcut': 112,
                                'action': function () {
                                    refreshCache();
                                }
                            },
                            'metadata': {
                                'label': 'Metadata',
                                'icon': 'glyphicon glyphicon-th',
                                'title': 'Open entity metadata. (Shortcut F2)',
                                'shortcut': 113,
                                'action': function () {
                                    tableMetadataModal(node);
                                },
                                // catalog or schema doesn't have metadata.
                                '_disabled': node.parent === "#"
                            }
                        };
                        return items;
                    }
                }

                /**
                 * Table metadata modal. 
                 * 
                 * @param {type} node
                 * @returns {undefined}
                 */
                function tableMetadataModal(node) {
                    var url = /*[[@{/connection/modal/}]]*/ "/connection/modal/";

                    $.ajax({
                        type: "GET",
                        url: url + connection + "/table/column/" + node.a_attr.catalog + "/" + node.a_attr.schema + "/" + node.a_attr.table,
                        success: function (result) {
                            $("#modalHolder").html(result);
                            $("#modalTableMetadata").modal({backdrop: 'static', keyboard: false});
                        },
                        error: function (e) {
                            alert("Error getting table metadata: " + e.statusText);
                        }
                    });
                }

                /**
                 * Calls modal with form to store the query. 
                 * @returns {undefined}
                 */
                function queryStoreModal() {
                    var connection = $('#connection').val();
                    var url = /*[[@{/query/store/modal/}]]*/ "/query/store/modal/";
                    var query = window.editor.getValue();

                    $.ajax({
                        type: "POST",
                        url: url + connection,
                        data: query,
                        contentType: "text/html",
                        timeout: 1000000,
                        success: function (result) {
                            $("#modalHolder").html(result);
                            $("#modalQueryStore").modal({backdrop: 'static'});
                        },
                        error: function (e) {
                            alert("Fail loading query resultset: " + e.statusText);
                        }
                    });
                }

                /**
                 * Ajax to call export for a query. 
                 * @returns {undefined}
                 */
                function queryExport() {
                    var connection = $('#connection').val();
                    var url = /*[[@{/export/query/}]]*/ "/export/query/";
                    var query = window.editor.getValue();

                    //Identify if query field is not empty.
                    if (query.toString().trim() !== "") {
                        $.ajax({
                            type: "POST",
                            url: url + connection,
                            data: query,
                            contentType: "text/html",
                            timeout: 1000000,
                            success: function (result) {
                                if (result !== "") {
                                    url = /*[[@{/export/download/}]]*/ "/export/download/";
                                    window.location.href = url + result;
                                } else {
                                    toastr.error('Fail exporting query!');
                                }
                            },
                            error: function (e) {
                                toastr.error("Fail exporting query, error: " + e.statusText);
                            }
                        });
                    }
                }
            });
        </script>    
    </body>
</html>
